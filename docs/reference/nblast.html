<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Calculate similarity score for neuron morphologies — nblast • nat.nblast</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>

<!-- mathjax -->
<script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">nat.nblast</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/jefferislab/nat.nblast">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

      <div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Calculate similarity score for neuron morphologies</h1>
    </div>

    
    <p>Uses the NBLAST algorithm that compares the morphology of two neurons. For
more control over the parameters of the algorithm, see the arguments of
<code><a href='NeuriteBlast.html'>NeuriteBlast</a></code>.</p>
    

    <pre><span class='fu'>nblast</span>(<span class='no'>query</span>, <span class='kw'>target</span> <span class='kw'>=</span> <span class='fu'>getOption</span>(<span class='st'>"nat.default.neuronlist"</span>), <span class='kw'>smat</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>sd</span> <span class='kw'>=</span> <span class='fl'>3</span>, <span class='kw'>version</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='fl'>2</span>, <span class='fl'>1</span>), <span class='kw'>normalised</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>, <span class='kw'>UseAlpha</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>,
  <span class='kw'>OmitFailures</span> <span class='kw'>=</span> <span class='fl'>NA</span>, <span class='no'>...</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a> Arguments</h2>
    <dl class="dl-horizontal">
      <dt>query</dt>
      <dd>the query neuron.</dd>
      <dt>target</dt>
      <dd>a <code><a href='http://www.rdocumentation.org/packages/nat/topics/neuronlist'>neuronlist</a></code> to compare neuron against.
Defaults to <code>options(&quot;nat.default.neuronlist&quot;)</code>. See
<code>nat-package</code>.</dd>
      <dt>smat</dt>
      <dd>the scoring matrix to use (see details)</dd>
      <dt>sd</dt>
      <dd>Standard deviation to use in distance dependence of nblast v1
algorithm. Ignored when <code>version=2</code>.</dd>
      <dt>version</dt>
      <dd>the version of the algorithm to use (the default, 2, is the
latest).</dd>
      <dt>normalised</dt>
      <dd>whether to divide scores by the self-match score of the
query</dd>
      <dt>UseAlpha</dt>
      <dd>whether to consider local directions in the similarity
calculation (default: FALSE).</dd>
      <dt>OmitFailures</dt>
      <dd>Whether to omit neurons for which <code>FUN</code> gives an
error. The default value (<code>NA</code>) will result in nblast stopping with an
error message the moment there is an eror. For other values, see details.</dd>
      <dt>...</dt>
      <dd>Additional arguments passed to NeuriteBlast or the function used
to compute scores from distances/dot products. (expert use only).</dd>
    </dl>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>Named list of similarity scores.</p>
    
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>when <code>smat=NULL</code> options(&quot;nat.nblast.defaultsmat&quot;) will be
  checked and if NULL, then <code>smat.fcwb</code> or <code>smat_alpha.fcwb</code> will
  be used depending on the value of <code>UseAlpha</code>.</p>
    <p>When <code>OmitFailures</code> is not <code>NA</code>, individual nblast calls will be
  wrapped in <code>try</code> to ensure that failure for any single neuron does not
  abort the whole nblast call. When <code>OmitFailures=FALSE</code>, missing values
  will be left as <code>NA</code>. <code>OmitFailures=TRUE</code> is not (yet)
  implemented. If you want to drop scores for neurons that failed you will
  need to set <code>OmitFailures=FALSE</code> and then use <code>na.omit</code> or
  similar to post-process the scores.</p>
    <p>Note that when <code>OmitFailures=FALSE</code> error messages will not be printed
  because the call is wrapped as <code>try(expr, silent=TRUE)</code>.</p>
    <p>Internally, the <code>plyr</code> package is used to provide options for
  parallelising NBLASTs and displaying progress. To display a progress bar as
  the scores are computed, add <code>.progress=&quot;text&quot;</code> to the arguments
  (non-text progress bars are available -- see
  <code><a href='http://www.rdocumentation.org/packages/plyr/topics/create_progress_bar'>create_progress_bar</a></code>). To parallelise, add
  <code>.parallel=TRUE</code> to the arguments. In order to make use of parallel
  calculation, you must register a parallel backend that will distribute the
  computations. There are several possible backends, the simplest of which is
  the multicore option made available by <code>doMC</code>, which spreads the load
  across cores of the same machine. Before using this, the backend must be
  registered using <code>registerDoMC</code> (see example below).</p>
    
    <h2 class="hasAnchor" id="nblast-versions"><a class="anchor" href="#nblast-versions"></a>NBLAST Versions</h2>

    <p>The <code>nblast</code> version argument presently
  exposes two versions of the algorithm; both use the same core procedure of
  aligning two vector clouds, segment by segment, and then computing the
  distance and absolute dot product between the nearest segment in the target
  neuron for every segment in the query neuron. However they differ
  significantly in the procedure used to calculate a score using this set of
  distances and absolute dot products.</p>
    <p><b>Version 1</b> of the algorithm uses a standard deviation (argument
  <code>sd</code>) as a user-supplied parameter for a negative exponential
  weighting function that determines the relationship between score and the
  distance between segments. This corresponds to the parameter \(\sigma\)
  in the weighting function:</p>
    <p>\(f=\sqrt{|\vec{u_{i}}\cdot\vec{v_{i}}|\exp\left(-d_{i}^{2}/2\sigma^{2}\right)}\)</p>
    <p>This is the same approach described in Kohl et al 2013 and the similarity
  scores in the interval (0,1) described in that paper can exactly
  recapitulated by setting <code>version=1</code> and <code>normalised=TRUE</code>.</p>
    <p><b>Version 2</b> of the algorithm is described in Costa et al 2014. This
  uses a more sophisticated and principled scoring approach based on a
  log-odds ratio defined by the distribution of matches and non-matches in
  sample data. This information is passed to the nblast function in the form
  of a <em>scoring matrix</em> (which can be computed by
  <code><a href='create_scoringmatrix.html'>create_scoringmatrix</a></code>); a default scoring matrix
  <code><a href='smat.fcwb.html'>smat.fcwb</a></code> has been constructed for <em>Drosophila</em> neurons.</p>
    <p><b>Which version should I use?</b> You should use version 2 if you are
  working with <em>Drosophila</em> neurons or you have sufficient training data
  (in the form of validated matching and random neuron pairs to construct a
  scoring matrix). If this is not the case, you can always fall back to
  version 1, setting the free parameter (sd or \(\sigma\)) to a value that
  encapsulates your understanding of the location precision of neurons in
  your species/brain region of interest. In the fly brain we have used
  \(\sigma=3\) microns, since previous estimates of the localisation of
  identifiable features of neurons (Jefferis, Potter et al 2007) are of this
  order.</p>
    
    <h2 class="hasAnchor" id="references"><a class="anchor" href="#references"></a>References</h2>

    <p>Kohl, J. Ostrovsky, A.D., Frechter, S., and Jefferis, G.S.X.E
(2013). A bidirectional circuit switch reroutes pheromone signals in male and
female brains. Cell 155 (7), 1610--23
<a href = 'doi:
10.1016/j.cell.2013.11.025'>http://dx.doi.org/10.1016/j.cell.2013.11.025</a>.</p>
    <p>Costa, M., Ostrovsky, A.D., Manton, J.D., Prohaska, S., and Jefferis,
G.S.X.E. (2014). NBLAST: Rapid, sensitive comparison of neuronal structure
and construction of neuron family databases. Biorxiv preprint.
<a href = 'doi: 10.1101/006346'>http://dx.doi.org/10.1101/006346</a>.</p>
    <p>Jefferis G.S.X.E., Potter C.J., Chan A.M., Marin E.C., Rohlfing T., Maurer
C.R.J., and Luo L. (2007). Comprehensive maps of Drosophila higher olfactory
centers: spatially segregated fruit and pheromone representation. Cell 128
(6), 1187--1203.
<a href = 'doi:10.1016/j.cell.2007.01.040'>http://dx.doi.org/10.1016/j.cell.2007.01.040</a></p>
    
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <p><code>nat-package</code>, <code><a href='nblast_allbyall.html'>nblast_allbyall</a></code>,
  <code><a href='create_scoringmatrix.html'>create_scoringmatrix</a></code>, <code><a href='smat.fcwb.html'>smat.fcwb</a></code></p>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'># load sample Kenyon cell data from nat package</span>
<span class='fu'>data</span>(<span class='no'>kcs20</span>, <span class='kw'>package</span><span class='kw'>=</span><span class='st'>'nat'</span>)
<span class='co'># search one neuron against all neurons</span>
<span class='no'>scores</span><span class='kw'>=</span><span class='fu'>nblast</span>(<span class='no'>kcs20</span><span class='kw'>[[</span><span class='st'>'GadMARCM-F000142_seg002'</span>]], <span class='no'>kcs20</span>)
<span class='co'># scores from best to worst, top hit is of course same neuron</span>
<span class='fu'>sort</span>(<span class='no'>scores</span>, <span class='kw'>decreasing</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>)</div><div class='output co'>#&gt; GadMARCM-F000142_seg002 ChaMARCM-F000586_seg002 GadMARCM-F000423_seg001 
#&gt;               4043.1766               1914.8224               1772.8506 
#&gt; GadMARCM-F000442_seg002 FruMARCM-M000115_seg001 FruMARCM-F000085_seg001 
#&gt;               1007.4565                853.8108                713.2106 
#&gt; FruMARCM-F001929_seg001 FruMARCM-F001494_seg002 GadMARCM-F000050_seg001 
#&gt;                604.4071                481.4737                480.4146 
#&gt; GadMARCM-F000071_seg001 FruMARCM-M001339_seg001 FruMARCM-F000188_seg001 
#&gt;                448.1516                433.9340                404.0470 
#&gt; GadMARCM-F000476_seg001 FruMARCM-F000270_seg001 FruMARCM-F000706_seg001 
#&gt;                313.2021                254.7516                204.2116 
#&gt; FruMARCM-M000842_seg002 FruMARCM-M001051_seg002 FruMARCM-M001205_seg002 
#&gt;                196.4543                140.8164               -251.4999 
#&gt; GadMARCM-F000122_seg001 FruMARCM-F001115_seg002 
#&gt;               -262.2352               -520.2581 </div><div class='input'><span class='fu'>hist</span>(<span class='no'>scores</span>, <span class='kw'>breaks</span><span class='kw'>=</span><span class='fl'>25</span>, <span class='kw'>col</span><span class='kw'>=</span><span class='st'>'grey'</span>)</div><div class='input'><span class='fu'>abline</span>(<span class='kw'>v</span><span class='kw'>=</span><span class='fl'>1500</span>, <span class='kw'>col</span><span class='kw'>=</span><span class='st'>'red'</span>)</div><img src='nblast-5.png' alt='' width='540' height='400' /><div class='input'>
<span class='co'># plot query neuron</span>
<span class='fu'>open3d</span>()</div><div class='output co'>#&gt; glX 
#&gt;   2 </div><div class='input'><span class='co'># plot top 3 hits (including self match with thicker lines)</span>
<span class='fu'>plot3d</span>(<span class='no'>kcs20</span>[<span class='fu'>which</span>(<span class='fu'>sort</span>(<span class='no'>scores</span>, <span class='kw'>decreasing</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>)<span class='kw'>&gt;</span><span class='fl'>1500</span>)], <span class='kw'>lwd</span><span class='kw'>=</span><span class='fu'>c</span>(<span class='fl'>3</span>,<span class='fl'>1</span>,<span class='fl'>1</span>))
<span class='no'>rest</span><span class='kw'>=</span><span class='fu'>names</span>(<span class='fu'>which</span>(<span class='no'>scores</span><span class='kw'>&lt;</span><span class='fl'>1500</span>))
<span class='fu'>plot3d</span>(<span class='no'>rest</span>, <span class='kw'>db</span><span class='kw'>=</span><span class='no'>kcs20</span>, <span class='kw'>col</span><span class='kw'>=</span><span class='st'>'grey'</span>, <span class='kw'>lwd</span><span class='kw'>=</span><span class='fl'>0.5</span>)

<span class='co'># normalised scores (i.e. self match = 1) of all neurons vs each other</span>
<span class='co'># note use of progress bar</span>
<span class='no'>scores.norm</span><span class='kw'>=</span><span class='fu'>nblast</span>(<span class='no'>kcs20</span>, <span class='no'>kcs20</span>, <span class='kw'>normalised</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>, <span class='kw'>.progress</span><span class='kw'>=</span><span class='st'>"text"</span>)</div><div class='output co'>#&gt;   |                                                                              |                                                                      |   0%  |                                                                              |====                                                                  |   5%  |                                                                              |=======                                                               |  10%  |                                                                              |==========                                                            |  15%  |                                                                              |==============                                                        |  20%  |                                                                              |==================                                                    |  25%  |                                                                              |=====================                                                 |  30%  |                                                                              |========================                                              |  35%  |                                                                              |============================                                          |  40%  |                                                                              |================================                                      |  45%  |                                                                              |===================================                                   |  50%  |                                                                              |======================================                                |  55%  |                                                                              |==========================================                            |  60%  |                                                                              |==============================================                        |  65%  |                                                                              |=================================================                     |  70%  |                                                                              |====================================================                  |  75%  |                                                                              |========================================================              |  80%  |                                                                              |============================================================          |  85%  |                                                                              |===============================================================       |  90%  |                                                                              |==================================================================    |  95%  |                                                                              |======================================================================| 100%</div><div class='input'><span class='fu'>hist</span>(<span class='no'>scores.norm</span>, <span class='kw'>breaks</span><span class='kw'>=</span><span class='fl'>25</span>, <span class='kw'>col</span><span class='kw'>=</span><span class='st'>'grey'</span>)</div><img src='nblast-11.png' alt='' width='540' height='400' /><div class='input'><span class='co'># produce a heatmap from normalised scores</span>
<span class='no'>jet.colors</span> <span class='kw'>&lt;-</span> <span class='fu'>colorRampPalette</span>( <span class='fu'>c</span>(<span class='st'>"blue"</span>, <span class='st'>"green"</span>, <span class='st'>"yellow"</span>, <span class='st'>"red"</span>) )
<span class='fu'>heatmap</span>(<span class='no'>scores.norm</span>, <span class='kw'>labCol</span> <span class='kw'>=</span> <span class='fu'>with</span>(<span class='no'>kcs20</span>,<span class='no'>type</span>), <span class='kw'>col</span><span class='kw'>=</span><span class='fu'>jet.colors</span>(<span class='fl'>20</span>), <span class='kw'>symm</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>)</div><img src='nblast-13.png' alt='' width='540' height='400' /><div class='input'>
<span class='co'>## Not run: ------------------------------------</span>
<span class='co'># # Parallelise NBLASTing across 4 cores using doMC package</span>
<span class='co'># library(doMC)</span>
<span class='co'># registerDoMC(4)</span>
<span class='co'># scores.norm2=nblast(kcs20, kcs20, normalised=TRUE, .parallel=TRUE)</span>
<span class='co'># stopifnot(all.equal(scores.norm2, scores.norm))</span>
<span class='co'>## ---------------------------------------------</span></div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>

      <li><a href="#details">Details</a></li>

      <li><a href="#nblast-versions">NBLAST Versions</a></li>

      <li><a href="#references">References</a></li>

      <li><a href="#see-also">See also</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by Gregory Jefferis, James Manton.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  </body>
</html>
